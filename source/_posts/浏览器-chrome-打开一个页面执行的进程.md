---
title: 浏览器 chrome 打开一个页面执行的进程
date: 2020-11-13 12:44:23
tags:
- browser
---

网络流程、
页面渲染过程、
javascript 执行流程
网络安全理论


了解 chrome 浏览器启动了几个进程
> chrome 选项 -> more tools -> task manager

多线程并行处理能大大提升性能，但是线程不能单独存在，需要进行来启动、管理。一个进程是一个程序的运行实例。也就是说，启动一个程序时，操作系统为该程序创建一个内存空间，用于存放代码、运行数据和执行任务的主线程。这个运行环境就是一个进程。

<!--more-->

## 进程与线程的关系·
1.  进程中的任意线程执行出错，整个进程崩溃；
2.  线程之间共享进程中的数据；
3.  当一个进程关闭之后，操作系统会回收进程战胜的内存；
4.  进程之间的内容相互隔离。

## 单进程浏览器时代
浏览器的所有功能模块（像网络、插件、javascript 运行环境、渲染引擎和页面）运行在同一个进程里。多个功能模块运行在一个进程中，导致浏览器不稳定、不安全、不流畅。
2007 年前的浏览器大多都是单线程，早期浏览器需要借助插件实现 Web 视频和 web 游戏的功能，插件是最容易出问题的模块，运行在浏览器进程中，很容易由于插件崩溃引起浏览器崩溃。另外渲染模块也不稳定。复杂的 javascript 代码就有可能引起渲染引擎模块崩溃，导致整个浏览器崩溃。
通常一个线程一直占用，或内存泄漏。运行比较复杂的页面会存在内存不能完全回收的情况，如此使用时间越长、内存占用越高、浏览器会变得越来越慢。
使用插件意味着该插件可以完全操作你的电脑，恶意插件会释放病毒、窃取账号密码。存在安全问题。

## 多进程浏览器时代
{% plantuml %}
  [插件进程] <<plugin process>>

  node 浏览器主进程 <<浏览器主进程负责下载资源\n管理 IPC\n显示渲染进程生成的图片>>

  rectangle "渲染进程负责：\n解析、渲染、Javascript 执行、\n合成网页页面；\n渲染进程在沙箱里面，\n不能读写硬盘上的数据，\n也不能获取操作系统权限" <<render process 沙箱>> {
    [渲染进程] <<render process 沙箱>>
    [渲染进程]..>浏览器主进程
  }

  [插件进程]..> 浏览器主进程

{% endplantuml %}

Chrome 插件及渲染都运行在各自单独的进程中，进程之间通过 ipc 机制进行通信。
当前页面或插件崩溃，只影响到当前页面或插件进程，浏览器的其它页面不受影响，解决了页面或插件崩溃导致的整个浏览器崩溃的 **不稳定** 的问题。
渲染页面是在沙箱中进行的，不能在硬盘上写入任何数据，也不能在敏感位置读取数据，恶意程序不能通过沙箱破坏系统，解决了 **不安全** 的问题。
Javascript 渲染进程中，阻塞渲染进程，并不会影响到浏览器其它页面，脚本运行在自己的沉浸进程中，死循环影响的仅仅是当前页面的渲染进程，解决了 **不流畅** 的问题。内存泄漏，只需要关闭当前页面，资源就能被系统回收。

## 目前的多进程框架
{% plantuml %}
[渲染进程 —— 核心任务是将 html、css、javascript \n转换为用户可以与之交互的网页。\n排版引擎 Blink 和 Javascript 引擎 V8 都是运行在该进程中] <<render process>>
[插件进程 —— 负责插件运行，\n保证不会因插件崩溃导致浏览器和页面受影响] <<plugin process>>
[网络进程 —— 负责网络资源加载，\n之前是作为一个模块运行在浏览器进程中，\n最近独立出来，成为一个独立的进程] <<network process>>
[GPU进程 —— GPU 的初衷是实现 3D CSS 效果，chrome 的 UI 界面采用 GPU 来绘制] <<GPU process>>
[浏览器主进程 —— \n主要负责界面显示、\n用户交互、\n子进程管理，\n同时提供存储等功能] <<browser process>>

skinparam component {
  backgroundColor<<render process>> #f99
  backgroundColor<<plugin process>> #6aa
  backgroundColor<<browser process>> #fff
}
{% endplantuml %}

因为每个进程都会包含基本框架副本，多进程浏览器会 **占用更高资源**，这就意味着浏览器会消耗更多内存资源。更复杂的体系架构，模块之间会有耦合高，扩展性差。现在的框架难适应新的需求。

## 面向服务的架构(Services Oriented Architecture,SOA)
也就是说 Chrome 会朝向现代操作系统所采用的“面向服务的架构”方向发展，原来的各种模块会被重构成独立的服务（Service），每个服务都在独立的进程中运行。访问服务必须采用接口，通过 ipc 来通信，从而构建一个更内聚，松耦合、易于维护和扩展的系统，更好的实现 Chrome 简单、稳定、高速、安全的目标。
