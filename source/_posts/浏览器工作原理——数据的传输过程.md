---
layout: _post
title: 浏览器工作原理——数据的传输过程
date: 2020-11-11 13:32:59
tags:
- browser
- 浏览器工作原理
---


First Print 简称 FP，是指页面加载到首次开始绘制的时长。网络的加载速度是影响 FP 的重要因素。网络协议 HTTP、WebSocket 都是基于 TCP/IP 的。那么 web 世界中，tcp/ip 是如何工作的呢？

## 数据的传输过程
互联网中数据是通过数据包传递。如果数据量很大时会拆成很多小的数据包传输。

### 1.  数据包如何送达主机
数据包在互联网上进行传输需要符合网际协议（Internet Protocol, IP）标准。

```sequence
Note left of 主机A: 主机A\n上层数据包交给\n网络层
Note left of 主机A: 主机A\n网络层带ip头与数据包\n交给底层
主机A-->主机B:主机A通过底层将数据包与ip头交给主机B
Note right of 主机B: 主机B\n网络层数据包\n交给上层
Note right of 主机B: 数据包到达\n主机B上层
```

<!--more-->

### 2.  主机如何将数据转交给应用
通过用户数据协议（User Datagram Protocol）把指定的数据包发送给指定的程序。UDP 通过端口号把数据包分发给正确的程序。

```sequence
上层-->传输层:主机A\n上层将数据包给到\n传输层
传输层-->网络层:主机A传输层\n将数据包与UDP头\n给到网络层
网络层-->底层:主机A\n将数据包、UDP外加IP头\n给到低层
底层->底层:主机A底层\n将数据、UDP头、IP 头\n给到主机B
底层-->网络层:网络层解开ip，\n将数据与UDP给到传输层
网络层-->传输层:传输层解开 udp 头，\n识别端口号将数据\n给到上层应用
上层->上层:主机B某应用\n最终拿到数据
```

### 3.  数据是如何被完整地送达应用程序
UDP 存在两个问题：
1.  传输过程中容易丢包；
2.  大文件拆分成多个小文件传输，这些文件会经过不同的路由器，在不同的时间送达接收端。UDP 不知道如何组装这些数据包，把这些数据包还原成完整的文件。

TCP(Transmission Control Protocol,传输控制协议)。面向链接、可靠、基于字节流的传输层通信协议。

TCP 的优点在于：
1.  对于丢包的情况会提供重传机制；
2.  TCP 引入数据包排序机制，保证乱序数据包组合成一个完整的文件。

```sequence
上层-->传输层:主机A\n上层将数据包给到\n传输层
传输层-->网络层:主机A传输层\n将数据包与TCP头\n给到网络层
网络层-->底层:主机A\n将数据包、TCP外加IP头\n给到低层
底层->底层:主机A底层\n将数据、TCP头、IP 头\n给到主机B
底层-->网络层:网络层解开ip，\n将数据与TCP给到传输层
网络层-->传输层:传输层解开 TCP 头，\n识别端口号将数据\n给到上层应用
上层->上层:主机B某应用\n最终拿到数据
```

TCP 的生命周期包括：`建立连接`、`传输数据`、`断开链接`
* `建立连接阶段`。这个阶段是通过“三次握手”来建立客户端和服务器之间的连接。TCP 提供面向连接的通信传输。面向连接是指在数据通信开始之前先做好两端之间的准备工作。所谓三次握手，是指在建立一个 TCP 连接时，客户端和服务器总共要发送三个数据包以确认连接的建立。
* `传输数据阶段`。在该阶段，接收端需要对每个数据包进行确认操作，也就是接收端在接收到数据包之后，需要发送确认数据包给发送端。所以当发送端发送了一个数据包之后，在规定时间内没有接收到接收端反馈的确认消息，则判断为数据包丢失，并触发发送端的重发机制。同样，一个大的文件在传输过程中会被拆分成很多小的数据包，这些数据包到达接收端后，接收端会按照 TCP 头中的序号为其排序，从而保证组成完整的数据。
* `断开连接阶段`。数据传输完毕之后，就要终止连接了，涉及到最后一个阶段“四次挥手”来保证双方都能断开连接。
